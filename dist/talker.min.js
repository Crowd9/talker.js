!function(a,b){b.Talker=a;/*!
 * Talker.js 1.0.0 <https://github.com/secondstreet/talker.js>
 * Copyright 2014 Second Street
 * MIT License <http://opensource.org/licenses/MIT>
 */
var c="application/x-talkerjs-v1+json",d="timeout",e=f,f={};!function(a){function b(a){return"function"==typeof a}function c(a){"undefined"!=typeof setImmediate?setImmediate(a):"undefined"!=typeof process&&process.nextTick?process.nextTick(a):setTimeout(a,0)}a[0][a[1]]=function d(){function a(a,b){return null==e&&null!=a&&(e=a,f=b,g.length&&c(function(){for(var a=0;a<g.length;a++)g[a]()})),e}var e,f=[],g=[];return a.then=function(a,h){function i(){try{var c=e?a:h;if(b(c)){var d=function(a){var c,e=0;try{if(a&&("object"==typeof a||b(a))&&b(c=a.then)){if(a===j)throw new TypeError;c.call(a,function(){e++||d.apply(void 0,arguments)},function(a){e++||j(!1,[a])})}else j(!0,arguments)}catch(f){e++||j(!1,[f])}};d(c.apply(void 0,f||[]))}else j(e,f)}catch(g){j(!1,[g])}}var j=d();return null!=e?c(i):g.push(i),j},a}}("undefined"==typeof f?[window,"pinkySwear"]:[f,"exports"]);var g=f.exports;f=e;var h=function(a){function b(){}return b.prototype=a,new b};Talker=function(a,b){this.remoteWindow=a,this.remoteOrigin=b,this.timeout=3e3,this.handshaken=!1,this.handshake=g(),this._id=0,this._queue=[],this._sent={};var c=this;return window.addEventListener("message",function(a){c._receiveMessage(a)},!1),this._sendHandshake(),this},Talker.prototype.send=function(a,b,c){var e=new Talker.OutgoingMessage(this,a,b,c),f=g();return this._sent[e.id]=f,this._queue.push(e),this._flushQueue(),setTimeout(function(){f(!1,[new Error(d)])},this.timeout),f},Talker.prototype._receiveMessage=function(a){var b,c;try{b=JSON.parse(a.data)}catch(d){b={}}return this._isSafeMessage(a.source,a.origin,b.type)?(c=b.handshake||b.handshakeConfirmation,c?this._handleHandshake(b):this._handleMessage(b)):!1},Talker.prototype._isSafeMessage=function(a,b,d){var e,f,g;return e=a===this.remoteWindow,f="*"===this.remoteOrigin||b===this.remoteOrigin,g=d===c,e&&f&&g},Talker.prototype._handleHandshake=function(a){a.handshake&&this._sendHandshake(this.handshaken),this.handshaken=!0,this.handshake(!0,[this.handshaken]),this._flushQueue()},Talker.prototype._handleMessage=function(a){var b=new Talker.IncomingMessage(this,a.namespace,a.data,a.id),c=a.responseToId;return c?this._respondToMessage(c,b):this._broadcastMessage(b)},Talker.prototype._respondToMessage=function(a,b){this._sent[a]&&(this._sent[a](!0,[b]),delete this._sent[a])},Talker.prototype._broadcastMessage=function(a){this.onMessage&&this.onMessage.call(this,a)},Talker.prototype._sendHandshake=function(a){var b={type:c},d=a?"handshakeConfirmation":"handshake";b[d]=!0,this._postMessage(b)},Talker.prototype._nextId=function(){return this._id+=1},Talker.prototype._postMessage=function(a){this.remoteWindow&&this.remoteOrigin&&this.remoteWindow.postMessage(JSON.stringify(a),this.remoteOrigin)},Talker.prototype._flushQueue=function(){if(this.handshaken){var a=this._queue.shift();if(!a)return this._queue;if(this._postMessage(a),this._queue.length>0)return this._flushQueue()}return this._queue},Talker.Message=function(a,b,d){return this.talker=a,this.namespace=b,this.data=d,this.type=c,this},Talker.OutgoingMessage=function(a,b,c,d){Talker.Message.call(this,a,b,c),this.responseToId=d||null,this.id=this.talker._nextId()},Talker.OutgoingMessage.prototype=h(Talker.Message.prototype),Talker.OutgoingMessage.prototype.constructor=Talker.Message,Talker.OutgoingMessage.prototype.toJSON=function(){return{id:this.id,responseToId:this.responseToId,namespace:this.namespace,data:this.data,type:this.type}},Talker.IncomingMessage=function(a,b,c,d){Talker.Message.call(this,a,b,c),this.id=d},Talker.IncomingMessage.prototype=h(Talker.Message.prototype),Talker.IncomingMessage.prototype.constructor=Talker.Message,Talker.IncomingMessage.prototype.respond=function(a){return this.talker.send(null,a,this.id)}}({},function(){return this}());
//# sourceMappingURL=talker.min.js.map